name: Blog Post Total Counter

on:
  schedule:
    - cron: '0 */12 * * *'   # every 12 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  count_blogs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create counter script
        run: |
          cat > fetch_total_posts.py <<'PY'
          import urllib.request, urllib.error, time
          from datetime import datetime

          SITES = [
              "https://infinitecurios.blog/posts-count.txt",
              "https://ajstudios.dev/posts-count.txt",
              "https://aspartameawareness.org/posts-count.txt",
          ]

          UA = {"User-Agent": "PostCounter/1.0 (+https://github.com/uxillary/automated)"}

          def fetch_int(url):
              bust = int(time.time() // 3600)  # cache-buster
              req = urllib.request.Request(f"{url}?bust={bust}", headers=UA)
              try:
                  with urllib.request.urlopen(req, timeout=20) as r:
                      text = r.read().decode("utf-8", "ignore").strip()
                      return int("".join(ch for ch in text if ch.isdigit() or ch in "+-"))
              except Exception:
                  return 0  # if unreachable, count as 0

          total = sum(fetch_int(url) for url in SITES)

          # write to single file
          with open("docs/blog-total.txt", "w", encoding="utf-8") as f:
              f.write(str(total))

          # append to CSV history
          now = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
          with open("docs/blog-total.csv", "a", encoding="utf-8") as fcsv:
              fcsv.write(f"{now},{total}\n")
          PY

      - name: Run counter
        run: |
          python3 fetch_total_posts.py
          echo "Total blog posts: $(cat docs/blog-total.txt)"

      - name: Commit and push if changed
        run: |
          git config --global user.name "uxillary"
          git config --global user.email "adam@ajstudios.dev"
          git add docs/blog-total.txt docs/blog-total.csv fetch_total_posts.py
          git diff --cached --quiet || git commit -m "ðŸ“ Update total blog post count [skip ci]"
          git push
